<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>文件管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="container mt-4">
        <h2>文件管理</h2>

        <!-- 文件列表 -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>文件名</th>
                    <th>大小</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="fileList"></tbody>
        </table>
    </div>

    <!-- 模态框 -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">文件预览</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" class="img-fluid d-none">
                    <video id="previewVideo" controls class="w-100 d-none">
                        <source id="previewVideoSource" src="">
                    </video>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadFiles();

            // 监听模态框关闭事件，停止视频播放
            document.getElementById('previewModal').addEventListener('hidden.bs.modal', function () {
                const video = document.getElementById('previewVideo');
                video.pause();
                video.currentTime = 0;
            });
        });

        function loadFiles() {
            fetch('/list_video_files')
                .then(response => response.json())
                .then(files => {
                    const fileList = document.getElementById("fileList");
                    fileList.innerHTML = "";

                    files.forEach(file => {
                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.textContent = file.name;
                        row.appendChild(nameCell);

                        const sizeCell = document.createElement("td");
                        sizeCell.textContent = file.size;
                        row.appendChild(sizeCell);

                        const actionsCell = document.createElement("td");

                        const downloadBtn = document.createElement("a");
                        downloadBtn.href = `/download_video/${encodeURIComponent(file.name)}`;
                        downloadBtn.className = "btn btn-success btn-sm";
                        downloadBtn.textContent = "下载";
                        actionsCell.appendChild(downloadBtn);

                        const deleteBtn = document.createElement("button");
                        deleteBtn.className = "btn btn-danger btn-sm ms-1";
                        deleteBtn.textContent = "删除";
                        deleteBtn.onclick = function () { deleteFile(file.name); };
                        actionsCell.appendChild(deleteBtn);

                        if (file.name.endsWith('.jpg') || file.name.endsWith('.jpeg') || file.name.endsWith('.png') || file.name.endsWith('.gif') || file.name.endsWith('.mp4') || file.name.endsWith('.avi')) {
                            const previewBtn = document.createElement("button");
                            previewBtn.className = "btn btn-info btn-sm ms-1";
                            previewBtn.textContent = "预览";
                            previewBtn.onclick = function () { previewFile(file.name); };
                            actionsCell.appendChild(previewBtn);
                        }

                        row.appendChild(actionsCell);
                        fileList.appendChild(row);
                    });
                });
        }

        function previewFile(filename) {
            const fileUrl = `/download_video/${encodeURIComponent(filename)}`;
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const img = document.getElementById('previewImage');
            const video = document.getElementById('previewVideo');
            const videoSource = document.getElementById('previewVideoSource');

            img.classList.add('d-none');
            video.classList.add('d-none');

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error('File not found');
                    if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        img.src = fileUrl;
                        img.classList.remove('d-none');
                    } else if (filename.match(/\.(mp4|avi)$/i)) {
                        videoSource.src = fileUrl;
                        video.load();
                        video.classList.remove('d-none');
                    }
                    modal.show();
                })
                .catch(() => alert("预览失败，文件可能已被删除或路径错误"));
        }

        function deleteFile(filename) {
            if (!confirm(`确定要删除 ${filename} 吗？`)) return;

            fetch(`/delete_video/${encodeURIComponent(filename)}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        loadFiles();
                    } else {
                        alert("删除失败: " + data.message);
                    }
                });
        }
    </script>

</body>

</html>