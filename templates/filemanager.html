<!DOCTYPE html>
<html>

<head>
    <title>File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* é™åˆ¶è§†é¢‘å®½åº¦ï¼Œé€‚é…æ¨¡æ€æ¡† */
        #videoPreview {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }

        /* è®©æ¨¡æ€æ¡†æ›´å®½ï¼Œé¿å…è§†é¢‘è¿‡äºå‹ç¼© */
        .modal-lg {
            max-width: 80%;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% for crumb in breadcrumb %}
                {% if loop.last %}
                <li class="breadcrumb-item active">{{ crumb.name }}</li>
                {% else %}
                <li class="breadcrumb-item"><a href="/{{ crumb.path }}">{{ crumb.name }}</a></li>
                {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <!-- ä¸Šä¼ å’Œåˆ›å»ºæ–‡ä»¶å¤¹ -->
        <div class="row mb-3">
            <div class="col">
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="current_path" value="{{ current_path }}">
                    <div class="input-group">
                        <input type="file" class="form-control" name="file">
                        <button class="btn btn-primary" type="submit">ä¸Šä¼ æ–‡ä»¶</button>
                    </div>
                </form>
            </div>
            <div class="col">
                <form action="{{ url_for('create_folder') }}" method="post">
                    <input type="hidden" name="current_path" value="{{ current_path }}">
                    <div class="input-group">
                        <input type="text" class="form-control" name="folder_name" placeholder="æ–°å»ºæ–‡ä»¶å¤¹">
                        <button class="btn btn-secondary" type="submit">åˆ›å»º</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>æ–‡ä»¶å</th>
                    <th>æ–‡ä»¶å¤§å°</th>
                    <th>æ–‡ä»¶ç±»å‹</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- è¿”å›ä¸Šä¸€å±‚ç›®å½• -->
                {% if current_path %}
                <tr>
                    <td colspan="5">
                        <a href="/filemanager/{{ parent_path }}" class="btn btn-light">è¿”å›ä¸Šä¸€å±‚</a>
                    </td>
                </tr>
                {% endif %}

                {% for file in files %}
                <tr>
                    <td>
                        {% if file.is_dir %}
                        ğŸ“ <a href="/filemanager/{{ file.path }}">{{ file.name }}</a>
                        {% else %}
                        ğŸ“„ {{ file.name }}
                        {% endif %}
                    </td>
                    <td>{{ file.size }}</td>
                    <td>{{ file.type }}</td>
                    <td>{{ file.created }}</td>
                    <td>
                        {% if file.type.startswith('image') %}
                        <button class="btn btn-sm btn-info" onclick="previewFile('{{ file.path }}', 'image')">é¢„è§ˆ</button>
                        {% elif file.type.startswith('video') %}
                        <button class="btn btn-sm btn-info" onclick="previewFile('{{ file.path }}', 'video')">æ’­æ”¾</button>
                        {% endif %}
                        <a href="/download/{{ file.path }}" class="btn btn-sm btn-success">ä¸‹è½½</a>
                        <a href="{{ url_for('delete_file', filepath=file.path) }}" class="btn btn-sm btn-danger">åˆ é™¤</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–‡ä»¶é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imagePreview" class="img-fluid d-none">
                    <video id="videoPreview" class="d-none" controls>
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function previewFile(path, type) {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const imagePreview = document.getElementById('imagePreview');
            const videoPreview = document.getElementById('videoPreview');

            // å…ˆéšè—æ‰€æœ‰é¢„è§ˆå†…å®¹
            imagePreview.classList.add('d-none');
            videoPreview.classList.add('d-none');

            if (type === 'image') {
                imagePreview.src = '/preview/' + path;
                imagePreview.classList.remove('d-none');
            } else if (type === 'video') {
                videoPreview.src = '/preview/' + path;
                videoPreview.classList.remove('d-none');
                videoPreview.play();
            }

            modal.show();
        }

        // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œæš‚åœè§†é¢‘æ’­æ”¾ï¼Œå¹¶é‡ç½® src
        document.getElementById('previewModal').addEventListener('hidden.bs.modal', function () {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.pause();  // æš‚åœæ’­æ”¾
            videoPreview.src = '';  // é‡ç½® srcï¼Œé˜²æ­¢ç»§ç»­æ’­æ”¾
        });
    </script>
</body>

</html>